{% extends "base.html" %}

{% block title %}Visitor Entry - Guard Security Portal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>New Visitor Entry
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data" id="visitorForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="visitor_name" class="form-label">
                                <i class="fas fa-user me-2"></i>Visitor Name *
                            </label>
                            <input type="text" class="form-control" id="visitor_name" name="visitor_name" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="purpose_of_visit" class="form-label">
                                <i class="fas fa-clipboard me-2"></i>Purpose of Visit *
                            </label>
                            <select class="form-control" id="purpose_of_visit" name="purpose_of_visit" required>
                                <option value="">Select Purpose</option>
                                <option value="Business Meeting">Business Meeting</option>
                                <option value="Delivery">Delivery</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Interview">Interview</option>
                                <option value="Personal Visit">Personal Visit</option>
                                <option value="Official Work">Official Work</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-camera me-2"></i>Visitor Photo
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="file" class="form-control" id="visitor_image" name="visitor_image" accept="image/*" capture="camera">
                                <small class="form-text text-muted">Take photo or upload image</small>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary w-100" id="cameraBtn">
                                    <i class="fas fa-camera me-2"></i>Use Camera
                                </button>
                            </div>
                        </div>
                        <div id="cameraPreview" class="mt-3" style="display: none;">
                            <video id="video" width="100%" height="200" autoplay></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div class="mt-2">
                                <button type="button" class="btn btn-success" id="captureBtn">
                                    <i class="fas fa-camera me-2"></i>Capture Photo
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancelCameraBtn">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                        <div id="imagePreview" class="mt-3"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock me-2"></i>Check-in Time
                            </label>
                            <input type="text" class="form-control" id="checkin_time" readonly>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar me-2"></i>Check-in Date
                            </label>
                            <input type="text" class="form-control" id="checkin_date" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-signature me-2"></i>Visitor Signature (Optional)
                        </label>
                        <div class="border rounded p-3">
                            <canvas id="signatureCanvas" width="100%" height="150" style="border: 1px dashed #ccc; width: 100%; cursor: crosshair;"></canvas>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSignature">
                                    <i class="fas fa-eraser me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="visitor_signature" id="visitor_signature">
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Record Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update current time and date in IST
    function updateDateTime() {
        const now = new Date();
        // Use IST timezone for display
        const timeOptions = { 
            hour: 'numeric', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: true,
            timeZone: 'Asia/Kolkata'
        };
        const dateOptions = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            timeZone: 'Asia/Kolkata'
        };
        
        document.getElementById('checkin_time').value = now.toLocaleTimeString('en-IN', timeOptions);
        document.getElementById('checkin_date').value = now.toLocaleDateString('en-IN', dateOptions);
    }
    
    // Update every second
    setInterval(updateDateTime, 1000);
    updateDateTime();
    
    // Camera functionality
    let stream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    document.getElementById('cameraBtn').addEventListener('click', async function() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' } 
            });
            video.srcObject = stream;
            document.getElementById('cameraPreview').style.display = 'block';
        } catch (err) {
            alert('Camera access denied or not available');
        }
    });
    
    document.getElementById('captureBtn').addEventListener('click', function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        canvas.toBlob(function(blob) {
            const file = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById('visitor_image').files = dataTransfer.files;
            
            // Show preview
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            img.style.maxWidth = '200px';
            img.className = 'img-thumbnail';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imagePreview').appendChild(img);
        });
        
        // Stop camera
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('cameraPreview').style.display = 'none';
    });
    
    document.getElementById('cancelCameraBtn').addEventListener('click', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('cameraPreview').style.display = 'none';
    });
    
    // File input preview
    document.getElementById('visitor_image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '200px';
            img.className = 'img-thumbnail';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imagePreview').appendChild(img);
        }
    });
    
    // Signature pad functionality
    const signatureCanvas = document.getElementById('signatureCanvas');
    const signatureCtx = signatureCanvas.getContext('2d');
    let isDrawing = false;
    
    // Set canvas size
    function resizeCanvas() {
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCanvas.width = rect.width;
        signatureCanvas.height = 150;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    signatureCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        signatureCanvas.dispatchEvent(mouseEvent);
    });
    
    signatureCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        signatureCanvas.dispatchEvent(mouseEvent);
    });
    
    signatureCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        signatureCanvas.dispatchEvent(mouseEvent);
    });
    
    function startDrawing(e) {
        isDrawing = true;
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCtx.beginPath();
        signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
    
    function draw(e) {
        if (!isDrawing) return;
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        signatureCtx.strokeStyle = '#000';
        signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        signatureCtx.stroke();
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    document.getElementById('clearSignature').addEventListener('click', function() {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    });
    
    // Form submission
    document.getElementById('visitorForm').addEventListener('submit', function(e) {
        // Save signature as base64
        const signatureData = signatureCanvas.toDataURL();
        document.getElementById('visitor_signature').value = signatureData;
    });
</script>
{% endblock %}
