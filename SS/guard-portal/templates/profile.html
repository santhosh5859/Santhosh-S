{% extends "base.html" %}

{% block title %}Profile - Guard Security Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>Personal Information
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 100px; height: 100px;">
                        <i class="fas fa-user fa-3x text-white"></i>
                    </div>
                    <h4>{{ guard.full_name }}</h4>
                    <p class="text-muted mb-1">Badge ID: {{ guard.badge_id }}</p>
                    <small class="text-muted member-since" data-time="{{ guard.created_at }}">Member since {{ guard.created_at }}</small>
                </div>
                
                <div class="row text-start">
                    <div class="col-12 mb-2">
                        <strong>Full Name:</strong><br>
                        <span class="text-muted">{{ guard.full_name }}</span>
                    </div>
                    <div class="col-12 mb-2">
                        <strong>Badge ID:</strong><br>
                        <span class="text-muted">{{ guard.badge_id }}</span>
                    </div>
                    {% if guard.phone %}
                    <div class="col-12 mb-2">
                        <strong>Phone:</strong><br>
                        <span class="text-muted">{{ guard.phone }}</span>
                    </div>
                    {% endif %}
                    {% if guard.email %}
                    <div class="col-12 mb-2">
                        <strong>Email:</strong><br>
                        <span class="text-muted">{{ guard.email }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <button class="btn btn-outline-primary w-100 mt-3" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Duty Logs
                </h5>
            </div>
            <div class="card-body">
                {% if duty_logs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Login Time</th>
                                <th>Logout Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in duty_logs %}
                            <tr>
                                <td class="duty-date" data-time="{{ log.login_time }}">{{ log.login_time }}</td>
                                <td class="duty-login" data-time="{{ log.login_time }}">{{ log.login_time }}</td>
                                <td>
                                    {% if log.logout_time %}
                                        <span class="duty-logout" data-time="{{ log.logout_time }}">{{ log.logout_time }}</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.duration_minutes %}
                                        {{ (log.duration_minutes // 60) }}h {{ (log.duration_minutes % 60) }}m
                                    {% else %}
                                        <span class="text-muted" id="activeDuration">Calculating...</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.logout_time %}
                                        <span class="badge bg-secondary">Completed</span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-circle me-1" style="animation: pulse 2s infinite;"></i>On Duty
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No duty logs found</h5>
                    <p class="text-muted">Your duty logs will appear here after you start working</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-calendar-day fa-2x text-primary mb-2"></i>
                    <div class="stats-number" id="todayHours">0</div>
                    <h6>Hours Today</h6>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-calendar-week fa-2x text-success mb-2"></i>
                    <div class="stats-number" id="weekHours">0</div>
                    <h6>Hours This Week</h6>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-users fa-2x text-info mb-2"></i>
                    <div class="stats-number" id="totalVisitors">0</div>
                    <h6>Total Visitors</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_profile') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" value="{{ guard.full_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" name="phone" value="{{ guard.phone or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ guard.email or '' }}">
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password (required to save changes)</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="new_password" name="new_password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Format timestamps with IST timezone
    function parseTimestamp(timestamp) {
        if (typeof timestamp === 'string') {
            // SQLite stores in UTC, so we need to treat it as UTC
            const isoTimestamp = timestamp.replace(' ', 'T') + 'Z';
            return new Date(isoTimestamp);
        }
        return new Date(timestamp);
    }
    
    function formatDate(timestamp) {
        const date = parseTimestamp(timestamp);
        return date.toLocaleDateString('en-IN', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            timeZone: 'Asia/Kolkata'
        });
    }
    
    function formatTime(timestamp) {
        const date = parseTimestamp(timestamp);
        return date.toLocaleTimeString('en-IN', { 
            hour: 'numeric', 
            minute: '2-digit', 
            hour12: true,
            timeZone: 'Asia/Kolkata'
        });
    }
    
    function formatMemberSince(timestamp) {
        const date = parseTimestamp(timestamp);
        return date.toLocaleDateString('en-IN', { 
            month: 'long', 
            year: 'numeric',
            timeZone: 'Asia/Kolkata'
        });
    }
    
    // Format all timestamps on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Format member since date
        const memberSinceElement = document.querySelector('.member-since');
        if (memberSinceElement) {
            const timestamp = memberSinceElement.getAttribute('data-time');
            if (timestamp) {
                memberSinceElement.textContent = 'Member since ' + formatMemberSince(timestamp);
            }
        }
        
        // Format duty log dates
        document.querySelectorAll('.duty-date').forEach(function(element) {
            const timestamp = element.getAttribute('data-time');
            if (timestamp) {
                element.textContent = formatDate(timestamp);
            }
        });
        
        // Format duty login times
        document.querySelectorAll('.duty-login').forEach(function(element) {
            const timestamp = element.getAttribute('data-time');
            if (timestamp) {
                element.textContent = formatTime(timestamp);
            }
        });
        
        // Format duty logout times
        document.querySelectorAll('.duty-logout').forEach(function(element) {
            const timestamp = element.getAttribute('data-time');
            if (timestamp) {
                element.textContent = formatTime(timestamp);
            }
        });
    });
    
    // Calculate active duty duration
    function updateActiveDuration() {
        const activeDurationElement = document.getElementById('activeDuration');
        if (activeDurationElement) {
            activeDurationElement.textContent = 'Active';
        }
    }
    
    // Pulse animation for active status
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // Update stats (these would be calculated from backend data)
    document.getElementById('todayHours').textContent = '8';
    document.getElementById('weekHours').textContent = '40';
    document.getElementById('totalVisitors').textContent = '25';
    
    updateActiveDuration();
    setInterval(updateActiveDuration, 60000); // Update every minute
</script>
{% endblock %}
